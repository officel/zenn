---
title: "Terraform のバージョン制約"
emoji: "📌"
type: "tech"
topics: ["terraform","version"]
published: true
publication_name: "terraform_jp"
---

# tl;dr

@[card](https://qiita.com/advent-calendar/2024/terraform)

- [Version Constraints - Configuration Language | Terraform | HashiCorp Developer](https://developer.hashicorp.com/terraform/language/expressions/version-constraints)
- バージョン制約の使い方か、運用管理について

# ちょっとAIに頼ってみる

```txt
terraform を使ってインフラの管理をしています。version や require_version などの指定で、 ~>x.y.z のように指定していたため、Provider や module のバージョンアップが行われないまま半年以上が過ぎ、いざバージョンアップ対応を始めると破壊的変更の影響を受けて非常に困難な道のりになってしまいした。どうすればよかったでしょうか。というブログ記事をマークダウンで出力してください
```

みたいな感じで聞いてみたら次のように返ってきた（ふぅん）

```txt
# Terraform バージョン管理の失敗から学ぶ: 半年越しのバージョンアップ地獄

Terraform を使ってインフラを管理している皆さん、こんにちは。先日、あるプロジェクトで痛恨のミスをしてしまいました。その経験から、Terraform のバージョン管理の重要性について深く反省し、皆さんに共有したいと思います。

## 起こったこと

これまで、Terraform の Provider や Module のバージョン指定に `~>x.y.z` (例: `~> 3.0.0`) を多用していました。これは、メジャーバージョンを固定しつつ、マイナーバージョンとパッチバージョンを自動的に最新にアップデートしてくれる便利な指定方法です。しかし、この便利さが落とし穴となりました。

半年以上、この指定方法でインフラを管理していた結果、Provider や Module のアップデートが滞ってしまいました。  いざバージョンアップに着手しようとすると、予想だにしない困難に直面しました。具体的には：

* **破壊的変更 (Breaking Changes):**  半年間に渡って蓄積されたマイナーアップデートの中に、破壊的変更が含まれていました。既存のコードが完全に動かなくなり、修正に膨大な時間と労力を費やす羽目になりました。
* **互換性の問題:**  依存関係にある Provider や Module 間の互換性が崩れており、バージョンを逐一確認し、互換性のある組み合わせを慎重に選択する必要がありました。
* **テストの不足:**  長期間アップデートを放置していたため、テストが不足しており、変更の影響を把握するのに苦労しました。バグの発見・修正に多くの時間を要しました。
* **ロールバックの困難さ:**  変更が大きいため、ロールバックが非常に困難でした。万が一失敗した場合のリスクが高く、精神的な負担も大きかったです。

## なぜこうなったのか？

根本的な原因は、`~>x.y.z` の使い方と、バージョンアップ対応の遅延です。

* **`~>x.y.z` のリスク:**  `~>x.y.z` は便利ですが、マイナーアップデートに破壊的変更が含まれる可能性を常に考慮する必要があります。Terraform のドキュメントをよく読む、定期的なアップデートを試みるなど、リスク管理が必須です。
* **バージョンアップの遅延:**  小さな変更をこまめに行う方が、大きな変更を一気に対応するよりもはるかに容易です。半年もの間放置したことが、問題を深刻化させました。

## 今後の対策

今回の経験から、以下の対策を徹底することにしました。

* **`~>x.y.z` を極力避ける:**  可能であれば、具体的なバージョンを指定します (`x.y.z`)。どうしても可変にする必要がある場合は、より慎重に、破壊的変更がないかドキュメントを確認し、テスト環境で十分に検証してから適用します。
* **定期的なバージョンアップ:**  月に一度、もしくは短いスパンで定期的に Provider と Module のアップデートを実施します。小さな変更をこまめに行うことで、大きな変更に慌てることを防ぎます。
* **テスト環境の構築と活用:**  本番環境に適用する前に、必ずテスト環境で十分にテストを行います。これにより、破壊的変更や互換性の問題を早期に発見することができます。
* **バージョン管理ツールの活用:**  Terraform Cloud や GitHub Actions などのバージョン管理ツールを活用し、バージョンアップのプロセスを自動化します。
* **ドキュメントの熟読:**  Provider や Module のリリースノートを必ず確認し、破壊的変更がないかを確認します。

## まとめ

Terraform のバージョン管理は、インフラの安定運用に不可欠です。`~>x.y.z` のような便利な機能は、リスクを理解した上で慎重に使用する必要があります。定期的なバージョンアップと、十分なテストを怠らず、インフラの安定性を維持していきましょう。  今回の苦い経験が、皆さんにとっての教訓になれば幸いです。
```

# 実際のところ

- ペシミスティックオペレーター（`~>`のこと）の誤った使用により、期待されたバージョンが使用されなかった
- 破壊的変更と、互換性（似たようなもんだと思うけど）に関してはそのとおり
- テストとロールバックに関しては期待していない
- ワーキングディレクトリ（Terraformを実行するディレクトリ）でペシミスティックオペレーターを使用するなら、適用されなくなるバージョンに注意を払わないといけない（おいてけぼりになる
- 自作モジュールでペシミスティックオペレーターを使用するのは用途誤り（暴論
- 毎月どころか毎週、可能なら毎日でもツールとコード（Terraform本体、Provider,Moduleや自分たちのコード）の最新化と plan によるドリフト検知を行うべき
- 今後の対策でも触れられているとおり、ペシミスティックオペレーターは使わないにこしたことはない
- 定期的な自動実行で常に最新化（init --upgrade）して、ドリフトしたら対応する、を運用業務に組み込むのが望ましい
- renovate や dependabot で更新しても構わないとは思うけど、バージョンが変わった、を自分たちのコードベースに積み上げるのが本当に必要なことか考えるべき
- みたいなことを伝えていきたいんだけど、それぞれ主義主張があるよね、みたいな
